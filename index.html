<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Western Region Relievers Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f6f9; }
        h1 { text-align: center; }
        .kpi-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .kpi h2 { margin: 0; font-size: 22px; }
        .filters { display: flex; gap: 20px; margin-bottom: 20px; }
        select { padding: 5px; }
        .charts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        canvas { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #2c3e50; color: white; }
    </style>
</head>
<body>

<h1>Western Region Relievers Interactive Dashboard</h1>

<div class="filters">
    <div>
        <label>Region:</label>
        <select id="regionFilter"><option value="All">All</option></select>
    </div>
    <div>
        <label>Preferred School:</label>
        <select id="schoolFilter"><option value="All">All</option></select>
    </div>
    <div>
        <label>Recommended By:</label>
        <select id="recommendedFilter"><option value="All">All</option></select>
    </div>
</div>

<div class="kpi-container">
    <div class="kpi"><h3>Total Relievers</h3><h2 id="totalRelievers">0</h2></div>
    <div class="kpi"><h3>Unique Regions</h3><h2 id="uniqueRegions">0</h2></div>
    <div class="kpi"><h3>Preferred Schools</h3><h2 id="uniqueSchools">0</h2></div>
    <div class="kpi"><h3>Recommended Sources</h3><h2 id="uniqueRecommended">0</h2></div>
    <div class="kpi"><h3>Outsourcing HR Count</h3><h2 id="uniqueHR">0</h2></div>
</div>

<div class="charts">
    <canvas id="regionChart"></canvas>
    <canvas id="schoolChart"></canvas>
    <canvas id="recommendedChart"></canvas>
    <canvas id="hrChart"></canvas>
    <canvas id="relieversBySchoolChart"></canvas>
</div>

<table id="dataTable">
    <thead>
        <tr>
            <th>Region</th>
            <th>Name</th>
            <th>Preferred School</th>
            <th>Recommended By</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
let rawData = [];
let filteredData = [];
let charts = [];
const webAppURL = "https://script.google.com/a/macros/food4education.org/s/AKfycby7hd8p0CxEOO_jAJ0m6fiUv8rJQasOPrLPbfk9YEYaPzIgVbIDQNRQYvuSH4UC45JNnA/exec";

async function loadData() {
    try {
        const response = await fetch(webAppURL);
        const data = await response.json();

        console.log("DATA RECEIVED:", data);

        rawData = data;

        initializeFilters();
        applyFilters();

    } catch (error) {
        console.error("Error loading data:", error);
    }
}

loadData();

// Optional auto refresh every 5 minutes
setInterval(loadData, 300000);
function initializeFilters() {
    populateFilter('regionFilter', 'REGION');
    populateFilter('schoolFilter', 'PREFERRED SCHOOL');
    populateFilter('recommendedFilter', 'RECOMMENDED BY');
}

function populateFilter(filterId, field) {
    const select = document.getElementById(filterId);
    const values = [...new Set(rawData.map(d => d[field]).filter(v => v))];
    values.forEach(v => {
        const option = document.createElement('option');
        option.value = v;
        option.textContent = v;
        select.appendChild(option);
    });
    select.addEventListener('change', applyFilters);
}

function applyFilters() {
    const region = document.getElementById('regionFilter').value;
    const school = document.getElementById('schoolFilter').value;
    const recommended = document.getElementById('recommendedFilter').value;

    filteredData = rawData.filter(d =>
        (region === 'All' || d['REGION'] === region) &&
        (school === 'All' || d['PREFERRED SCHOOL'] === school) &&
        (recommended === 'All' || d['RECOMMENDED BY'] === recommended)
    );

    updateKPIs();
    updateCharts();
    updateTable();
}

function updateKPIs() {
    document.getElementById('totalRelievers').textContent = filteredData.length;
    document.getElementById('uniqueRegions').textContent = new Set(filteredData.map(d => d['REGION'])).size;
    document.getElementById('uniqueSchools').textContent = new Set(filteredData.map(d => d['PREFERRED SCHOOL'])).size;
    document.getElementById('uniqueRecommended').textContent = new Set(filteredData.map(d => d['RECOMMENDED BY'])).size;
    document.getElementById('uniqueHR').textContent = new Set(filteredData.map(d => d['OUTSOURCING HR'])).size;
}

function generateChart(ctxId, labelField) {
    const ctx = document.getElementById(ctxId).getContext('2d');
    const grouped = {};
    filteredData.forEach(d => {
        const key = d[labelField] || 'Unknown';
        grouped[key] = (grouped[key] || 0) + 1;
    });

    return new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(grouped),
            datasets: [{
                label: 'Count',
                data: Object.values(grouped)
            }]
        },
        options: { responsive: true }
    });
}

function updateCharts() {
    charts.forEach(c => c.destroy());
    charts = [];
    charts.push(generateChart('regionChart', 'REGION'));
    charts.push(generateChart('schoolChart', 'PREFERRED SCHOOL'));
    charts.push(generateChart('recommendedChart', 'RECOMMENDED BY'));
    charts.push(generateChart('hrChart', 'OUTSOURCING HR'));
    charts.push(generateChart('relieversBySchoolChart', 'PREFERRED SCHOOL'));
}

function updateTable() {
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    filteredData.forEach(d => {
        const row = `<tr>
            <td>${d['REGION'] || ''}</td>
            <td>${d['NAME'] || ''}</td>
            <td>${d['PREFERRED SCHOOL'] || ''}</td>
            <td>${d['RECOMMENDED BY'] || ''}</td>
        </tr>`;
        tbody.innerHTML += row;
    });
}
</script>

</body>
</html>
