<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Western Region Relievers Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f6f9; }
        h1 { text-align: center; }
        .kpi-container { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .kpi h2 { margin: 0; font-size: 22px; }
        .filters { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        select { padding: 5px; }
        .charts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        canvas { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #2c3e50; color: white; }
        a { color: #3498db; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>

<h1>Western Region Relievers Interactive Dashboard</h1>

<div class="filters">
    <div>
        <label>Region:</label>
        <select id="regionFilter"><option value="All">All</option></select>
    </div>
    <div>
        <label>Preferred School:</label>
        <select id="schoolFilter"><option value="All">All</option></select>
    </div>
    <div>
        <label>Recommended By:</label>
        <select id="recommendedFilter"><option value="All">All</option></select>
    </div>
    <div>
        <label>Role:</label>
        <select id="roleFilter"><option value="All">All</option></select>
    </div>
</div>

<div class="kpi-container">
    <div class="kpi"><h3>Total Relievers</h3><h2 id="totalRelievers">0</h2></div>
    <div class="kpi"><h3>Unique Regions</h3><h2 id="uniqueRegions">0</h2></div>
    <div class="kpi"><h3>Preferred Schools</h3><h2 id="uniqueSchools">0</h2></div>
    <div class="kpi"><h3>Recommended Sources</h3><h2 id="uniqueRecommended">0</h2></div>
    <div class="kpi"><h3>Outsourcing HR Count</h3><h2 id="uniqueHR">0</h2></div>
    <div class="kpi"><h3>Unique Roles</h3><h2 id="uniqueRoles">0</h2></div>
</div>

<div class="charts">
    <canvas id="regionChart"></canvas>
    <canvas id="schoolChart"></canvas>
    <canvas id="recommendedChart"></canvas>
    <canvas id="hrChart"></canvas>
    <canvas id="relieversBySchoolChart"></canvas>
</div>

<table id="dataTable">
    <thead>
        <tr>
            <th>Region</th>
            <th>Name</th>
            <th>Preferred School</th>
            <th>Recommended By</th>
            <th>Role</th>
            <th>Contact</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
let rawData = [];
let filteredData = [];
let charts = [];
const webAppURL = "https://script.google.com/macros/s/AKfycby7hd8p0CxEOO_jAJ0m6fiUv8rJQasOPrLPbfk9YEYaPzIgVbIDQNRQYvuSH4UC45JNnA/exec";

// Normalize keys and remove empty rows
function normalizeData(data) {
    return data
        .filter(d => d['NAME']) // remove empty placeholder rows
        .map(d => ({
            S_N: d['S/N'],
            REGION: d['REGION'],
            OUTSOURCING_HR: d['OUTSOURCING HR'],
            NAME: d['NAME'],
            CONTACT: d['CONTACT'],
            ID_NUMBER: d['ID NUMBER'],
            RECOMMENDED_BY: d['RECOMMENDED BY'],
            PREFERRED_SCHOOL: d['PREFERRED SCHOOL'],
            ROLE: d['ROLE']
        }));
}

async function loadData() {
    try {
        const response = await fetch(webAppURL);
        const data = await response.json();
        console.log("Raw DATA RECEIVED:", data);

        rawData = normalizeData(data); 
        console.log("Normalized DATA:", rawData);

        initializeFilters();
        applyFilters();

    } catch (error) {
        console.error("Error loading data:", error);
    }
}

setInterval(loadData, 300000);

function initializeFilters() {
    populateFilter('regionFilter', 'REGION');
    populateFilter('schoolFilter', 'PREFERRED_SCHOOL');
    populateFilter('recommendedFilter', 'RECOMMENDED_BY');
    populateFilter('roleFilter', 'ROLE');
}

function populateFilter(filterId, field) {
    const select = document.getElementById(filterId);
    select.innerHTML = '<option value="All">All</option>'; 
    const values = [...new Set(rawData.map(d => d[field]).filter(v => v))];
    values.forEach(v => {
        const option = document.createElement('option');
        option.value = v;
        option.textContent = v;
        select.appendChild(option);
    });
    select.addEventListener('change', applyFilters);
}

function applyFilters() {
    const region = document.getElementById('regionFilter').value;
    const school = document.getElementById('schoolFilter').value;
    const recommended = document.getElementById('recommendedFilter').value;
    const role = document.getElementById('roleFilter').value;

    filteredData = rawData.filter(d =>
        (region === 'All' || d['REGION'] === region) &&
        (school === 'All' || d['PREFERRED_SCHOOL'] === school) &&
        (recommended === 'All' || d['RECOMMENDED_BY'] === recommended) &&
        (role === 'All' || d['ROLE'] === role)
    );

    updateKPIs();
    updateCharts();
    updateTable();
}

function updateKPIs() {
    document.getElementById('totalRelievers').textContent = filteredData.length;
    document.getElementById('uniqueRegions').textContent = new Set(filteredData.map(d => d['REGION'])).size;
    document.getElementById('uniqueSchools').textContent = new Set(filteredData.map(d => d['PREFERRED_SCHOOL'])).size;
    document.getElementById('uniqueRecommended').textContent = new Set(filteredData.map(d => d['RECOMMENDED_BY'])).size;
    document.getElementById('uniqueHR').textContent = new Set(filteredData.map(d => d['OUTSOURCING_HR'])).size;
    document.getElementById('uniqueRoles').textContent = new Set(filteredData.map(d => d['ROLE'])).size;
}

function generateChart(ctxId, labelField) {
    const ctx = document.getElementById(ctxId).getContext('2d');
    const grouped = {};
    filteredData.forEach(d => {
        const key = d[labelField] || 'Unknown';
        grouped[key] = (grouped[key] || 0) + 1;
    });

    return new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(grouped),
            datasets: [{
                label: 'Count',
                data: Object.values(grouped),
                backgroundColor: 'rgba(54, 162, 235, 0.7)'
            }]
        },
        options: { responsive: true }
    });
}

function updateCharts() {
    charts.forEach(c => c.destroy());
    charts = [];
    charts.push(generateChart('regionChart', 'REGION'));
    charts.push(generateChart('schoolChart', 'PREFERRED_SCHOOL'));
    charts.push(generateChart('recommendedChart', 'RECOMMENDED_BY'));
    charts.push(generateChart('hrChart', 'OUTSOURCING_HR'));
    charts.push(generateChart('relieversBySchoolChart', 'PREFERRED_SCHOOL'));
}

function updateTable() {
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    filteredData.forEach(d => {
        const contactLink = d['CONTACT'] ? `<a href="tel:${d['CONTACT']}">${d['CONTACT']}</a>` : '';
        const row = `<tr>
            <td>${d['REGION'] || ''}</td>
            <td>${d['NAME'] || ''}</td>
            <td>${d['PREFERRED_SCHOOL'] || ''}</td>
            <td>${d['RECOMMENDED_BY'] || ''}</td>
            <td>${d['ROLE'] || ''}</td>
            <td>${contactLink}</td>
        </tr>`;
        tbody.innerHTML += row;
    });
}

loadData();
</script>

</body>
</html>
